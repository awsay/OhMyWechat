{% extends "base.html" %}
{% block style %}
    <link rel="stylesheet" href="static/assets/css/account.css">
{% endblock %}
{% block content %}
    {% import 'menu.html' as menu %}

    <div class="am-g tpl-g">
        <!-- 头部 -->
        <header>
            <!-- logo -->
            <div class="am-fl tpl-header-logo">
                <a href="javascript:;"><img src="static/assets/img/logo.png" alt=""></a>
            </div>
            <!-- 右侧内容 -->
            <div class="tpl-header-fluid">
                <!-- 侧边切换 -->
                <div class="am-fl tpl-header-switch-button am-icon-list">
                    <span>

                </span>
                </div>
                <!-- 搜索 -->
                <div class="am-fl tpl-header-search">
                    <form class="tpl-header-search-form" action="javascript:;">
                        <button class="tpl-header-search-btn am-icon-search"></button>
                        <input class="tpl-header-search-box" type="text" placeholder="搜索内容...">
                    </form>
                </div>
                <!-- 其它功能-->
                <div class="am-fr tpl-header-navbar">
                    <ul>
                        <!-- 欢迎语 -->
                        <li class="am-text-sm tpl-header-navbar-welcome">
                            <a href="javascript:;">欢迎你, <span>系统管理员</span> </a>
                        </li>

                        <!-- 新邮件 -->
                        <li class="am-dropdown tpl-dropdown" data-am-dropdown>
                            <a href="javascript:;" class="am-dropdown-toggle tpl-dropdown-toggle"
                               data-am-dropdown-toggle>
                                <i class="am-icon-envelope"></i>
                                <span class="am-badge am-badge-success am-round item-feed-badge">4</span>
                            </a>
                            <!-- 弹出列表 -->
                            <ul class="am-dropdown-content tpl-dropdown-content">
                                <li class="tpl-dropdown-menu-messages">
                                    <a href="javascript:;" class="tpl-dropdown-menu-messages-item am-cf">
                                        <div class="menu-messages-ico">
                                            <img src="static/assets/img/user04.png" alt="">
                                        </div>
                                        <div class="menu-messages-time">
                                            3小时前
                                        </div>
                                        <div class="menu-messages-content">
                                            <div class="menu-messages-content-title">
                                                <i class="am-icon-circle-o am-text-success"></i>
                                                <span>夕风色</span>
                                            </div>
                                            <div class="am-text-truncate"> Amaze UI 的诞生，依托于 GitHub 及其他技术社区上一些优秀的资源；Amaze
                                                UI 的成长，则离不开用户的支持。
                                            </div>
                                            <div class="menu-messages-content-time">2016-09-21 下午 16:40</div>
                                        </div>
                                    </a>
                                </li>

                                <li class="tpl-dropdown-menu-messages">
                                    <a href="javascript:;" class="tpl-dropdown-menu-messages-item am-cf">
                                        <div class="menu-messages-ico">
                                            <img src="static/assets/img/user02.png" alt="">
                                        </div>
                                        <div class="menu-messages-time">
                                            5天前
                                        </div>
                                        <div class="menu-messages-content">
                                            <div class="menu-messages-content-title">
                                                <i class="am-icon-circle-o am-text-warning"></i>
                                                <span>禁言小张</span>
                                            </div>
                                            <div class="am-text-truncate"> 为了能最准确的传达所描述的问题， 建议你在反馈时附上演示，方便我们理解。</div>
                                            <div class="menu-messages-content-time">2016-09-16 上午 09:23</div>
                                        </div>
                                    </a>
                                </li>
                                <li class="tpl-dropdown-menu-messages">
                                    <a href="javascript:;" class="tpl-dropdown-menu-messages-item am-cf">
                                        <i class="am-icon-circle-o"></i> 进入列表…
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <!-- 新提示 -->
                        <li class="am-dropdown" data-am-dropdown>
                            <a href="javascript:;" class="am-dropdown-toggle" data-am-dropdown-toggle>
                                <i class="am-icon-bell"></i>
                                <span class="am-badge am-badge-warning am-round item-feed-badge">5</span>
                            </a>

                            <!-- 弹出列表 -->
                            <ul class="am-dropdown-content tpl-dropdown-content">
                                <li class="tpl-dropdown-menu-notifications">
                                    <a href="javascript:;" class="tpl-dropdown-menu-notifications-item am-cf">
                                        <div class="tpl-dropdown-menu-notifications-title">
                                            <i class="am-icon-line-chart"></i>
                                            <span> 有6笔新的销售订单</span>
                                        </div>
                                        <div class="tpl-dropdown-menu-notifications-time">
                                            12分钟前
                                        </div>
                                    </a>
                                </li>
                                <li class="tpl-dropdown-menu-notifications">
                                    <a href="javascript:;" class="tpl-dropdown-menu-notifications-item am-cf">
                                        <div class="tpl-dropdown-menu-notifications-title">
                                            <i class="am-icon-star"></i>
                                            <span> 有3个来自人事部的消息</span>
                                        </div>
                                        <div class="tpl-dropdown-menu-notifications-time">
                                            30分钟前
                                        </div>
                                    </a>
                                </li>
                                <li class="tpl-dropdown-menu-notifications">
                                    <a href="javascript:;" class="tpl-dropdown-menu-notifications-item am-cf">
                                        <div class="tpl-dropdown-menu-notifications-title">
                                            <i class="am-icon-folder-o"></i>
                                            <span> 上午开会记录存档</span>
                                        </div>
                                        <div class="tpl-dropdown-menu-notifications-time">
                                            1天前
                                        </div>
                                    </a>
                                </li>


                                <li class="tpl-dropdown-menu-notifications">
                                    <a href="javascript:;" class="tpl-dropdown-menu-notifications-item am-cf">
                                        <i class="am-icon-bell"></i> 进入列表…
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <!-- 退出 -->
                        <li class="am-text-sm">
                            <a href="javascript:;">
                                <span class="am-icon-sign-out"></span> 退出
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </header>
        <!-- 风格切换 -->
        <div class="tpl-skiner">
            <div class="tpl-skiner-toggle am-icon-cog">
            </div>
            <div class="tpl-skiner-content">
                <div class="tpl-skiner-content-title">
                    选择主题
                </div>
                <div class="tpl-skiner-content-bar">
                    <span class="skiner-color skiner-white" data-color="theme-white"></span>
                    <span class="skiner-color skiner-black" data-color="theme-black"></span>
                </div>
            </div>
        </div>
        <!-- 侧边导航栏 -->
        {{ menu.left(activeMenu) }}
        <div class="tpl-content-wrapper">

            <div class="container-fluid am-cf">
                <div class="row">
                    <div class="am-u-sm-12 am-u-md-12 am-u-lg-9">
                        <div class="page-header-heading"><span class="am-icon-home page-header-heading-icon"></span>
                            账号管理
                            <small>OhMyWechat</small>
                        </div>
                        <p class="page-header-description">OhMyWechat系统致力于为您提供优雅的个人号运营系统</p>
                    </div>
                    <div class="am-u-lg-3 tpl-index-settings-button">
                        <button type="button" class="page-header-button" id="addAccount"><span
                                class="am-icon-paint-brush"></span> 添加账号
                        </button>
                    </div>
                </div>

            </div>

            <div class="row-content am-cf">
                <div class="row  am-cf" id="account_list">
{#                    <div class="am-u-sm-12 am-u-md-12 am-u-lg-3 widget-margin-bottom-lg ">#}
{#                        <div class="tpl-user-card am-text-center widget-body-lg">#}
{#                            <div class="tpl-user-card-title">#}
{#                                客服1#}
{#                            </div>#}
{#                            <div class="achievement-subheading">#}
{#                                <b>状态：</b>正常#}
{#                            </div>#}
{#                            <img class="achievement-image" src="static/assets/img/user07.png" alt="">#}
{#                            <div class="achievement-description">#}
{#                                <div class="am-btn-group am-padding-bottom-xl">#}
{#                                    <button type="button" class="am-btn am-btn-default">编辑账号</button>#}
{#                                    <button type="button" class="am-btn am-btn-warning">注销账号</button>#}
{#                                    <button type="button" class="am-btn am-btn-danger">删除账号</button>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
                </div>

            </div>
        </div>
        <div class="am-modal am-modal-no-btn" tabindex="-1" id="login-modal">
            <div class="am-modal-dialog">
                <div class="am-modal-hd">登录账号
                    <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
                </div>
                <div class="am-modal-bd">
                    <div id="loading">
                        <span class="am-icon-spinner am-icon-spin"></span>正在加载登录二维码
                    </div>
                    <div id="qrcode" class="m-active" style="display: none">
                        <img src="" alt="" id="qrcode_img">
                        <span id="qrcode_status">等待扫码</span>
                        <button type="button" class="am-btn am-btn-warning" id="reset_qrcode" style="display: none">
                            重新获取登录二维码
                        </button>
                    </div>
                    <div id="avatar" class="" style="display: none">
                        <img src="" alt="" id="avatar_img">
                        <span id="avatar_status">请点击手机上的确认按钮</span>
                        <button type="button" class="am-btn am-btn-warning" id="reset_avatar" style="display: none">
                            重新获取登录二维码
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="model" style="display:none">
        <div class="am-u-sm-12 am-u-md-12 am-u-lg-3 widget-margin-bottom-lg ">
            <div class="tpl-user-card am-text-center widget-body-lg">
                <div class="tpl-user-card-title nickname">

                </div>
                <div class="achievement-subheading status">
                    <b>状态：</b>正常
                </div>
                <img class="achievement-image" src="" alt="">
                <div class="achievement-description">
                    <div class="am-btn-group am-padding-bottom-xl">
                        <button type="button" class="am-btn am-btn-default">编辑账号</button>
                        <button type="button" class="am-btn am-btn-warning">注销账号</button>
                        <button type="button" class="am-btn am-btn-danger">删除账号</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        var $LoginModal = $('#login-modal');
        var $resetbtn = $('#reset_qrcode');
        var $resetbtn2 = $('#reset_avatar');
        var t;
        var checkLoginStatus = function () {

            $.ajax({
                url: '/api/checkLoginStatus',
                type: 'get',
                timeout: 30000,
                success: function (result) {
                    $result = JSON.parse(result);
                    flag = true;
                    if ($result.code == 408) {
                        //继续登录，不作任何操作
                    }
                    if ($result.code == 400) {
                        //登录超时，需要重新生成验证码
                        flag = false;
                        $('#qrcode_img').css('opacity', '0.1');
                        $('#avatar_img').css('opacity', '0.1');
                        $resetbtn.show();
                        $resetbtn2.show();
                    }
                    if ($result.code == 200) {
                        //登陆成功
                        $LoginModal.modal('close');
                        obj = $('#model').children().clone();
                        obj.find('.nickname').text($result.info.nickname);
                        obj.find('.achievement-image').attr('src',$result.info.avatar);
                        $('#account_list').append(obj);
                        flag = false;

                    }
                    if ($result.code == 201) {
                        //扫码成功
                        $LoginModal.find('#qrcode').hide();
                        $LoginModal.find('#avatar_img').attr('src', $result.avatar);
                        $LoginModal.find('#avatar').show();
                    }
                    if (flag) {
                        checkLoginStatus()
                    }
                }
            })
        };
        $LoginModal.find('#qrcode_img').on('load', function () {
            $LoginModal.find('#loading').hide();
            $LoginModal.find('#qrcode').show();
            $resetbtn.button('reset');
            $resetbtn.hide();
            checkLoginStatus()
        });
        $('#addAccount').on('click', function () {
            var timestamp = Date.parse(new Date());
            timestamp = timestamp / 1000;
            $LoginModal.find('#loading').show();
            $LoginModal.find('#qrcode').hide();
            $LoginModal.find('#qrcode_img').attr('src', '').attr('src', '/api/getQrCode?t=' + timestamp);
            $LoginModal.modal('open');
        });
        $('#reset_qrcode').click(function () {
            $resetbtn.button('loading');
            var timestamp = Date.parse(new Date());
            timestamp = timestamp / 1000;
            $LoginModal.find('#qrcode_img').attr('src', '').attr('src', '/api/getQrCode?t=' + timestamp);
        });

        $LoginModal.on('close.modal.amui', function () {
            $LoginModal.find('#avatar').hide();
            $LoginModal.find('#qrcode').show();
        });


    </script>
{% endblock %}